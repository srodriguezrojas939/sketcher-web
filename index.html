<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>RaizCuadra CAD - Pro Sketcher</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.15/paper-full.min.js"></script>
    <style>
        :root {
            --bg: #0d0d0d; --panel: #1a1a1a; --accent: #00ff41; 
            --blue: #3b82f6; --black: #e0e0e0; --red: #ff4d4d;
        }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Courier New', monospace; display: flex; height: 100vh; overflow: hidden; }
        
        #sidebar { width: 280px; background: var(--panel); border-right: 1px solid #333; display: flex; flex-direction: column; padding: 15px; }
        .tool-group { margin-bottom: 20px; }
        .tool-group h3 { font-size: 12px; color: var(--accent); text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .btn { width: 100%; background: transparent; border: 1px solid #444; color: #aaa; padding: 8px; margin: 4px 0; cursor: pointer; text-align: left; font-size: 11px; transition: 0.2s; }
        .btn:hover { border-color: var(--accent); color: white; }
        .btn.active { background: #333; border-color: var(--accent); color: var(--accent); }
        
        #viewport { flex-grow: 1; position: relative; cursor: crosshair; }
        canvas { width: 100%; height: 100%; background: radial-gradient(#222 1px, transparent 1px); background-size: 30px 30px; }
        
        /* Editor Flotante (Como pediste, sin ventanas prompt) */
        #dim-editor { 
            position: absolute; display: none; background: var(--panel); 
            border: 1px solid var(--accent); padding: 5px; 
            box-shadow: 0 0 10px rgba(0,255,65,0.2); z-index: 100;
        }
        #dim-editor input { background: black; border: 1px solid #444; color: var(--accent); width: 60px; text-align: center; outline: none; }
        
        .status-bar { position: absolute; bottom: 0; left: 280px; right: 0; background: rgba(0,0,0,0.8); padding: 5px 15px; font-size: 10px; display: flex; gap: 20px; border-top: 1px solid #333; }
    </style>
</head>
<body>

<div id="sidebar">
    <div style="font-size: 18px; font-weight: bold; margin-bottom: 20px; color: var(--accent);">[RAIZ_CUADRA] CAD</div>
    
    <div class="tool-group">
        <h3>Entidades</h3>
        <button class="btn active" id="tool-line" onclick="setMode('LINE')">> LINEA</button>
        <button class="btn" id="tool-rect" onclick="setMode('RECT')">> RECTANGULO</button>
        <button class="btn" id="tool-circle" onclick="setMode('CIRCLE')">> CIRCULO</button>
        <button class="btn" id="tool-trim" onclick="setMode('TRIM')">> RECORTAR</button>
    </div>

    <div class="tool-group">
        <h3>Dimensiones</h3>
        <button class="btn" id="tool-dim" onclick="setMode('DIM')">> COTA INTELIGENTE</button>
    </div>

    <div id="constraint-info" style="font-size: 10px; color: #666; margin-top: auto;">
        DOF: <span id="dof-count">0</span> | EJE: <span id="sketch-state">X,Y ACTIVOS</span>
    </div>
</div>

<div id="viewport">
    <canvas id="cadCanvas" resize></canvas>
    <div id="dim-editor"><input type="number" id="dim-input" placeholder="Val"></div>
    <div class="status-bar">
        <span style="color: var(--blue)">● SUBDEFINIDO</span>
        <span style="color: var(--accent)">● DEFINIDO (ORIGEN/SNAP)</span>
    </div>
</div>

<script>
paper.setup('cadCanvas');
const { Path, Point, Color, Group, TextItem } = paper;

// --- CONFIGURACIÓN DE EJES Y ORIGEN ---
const origin = paper.view.center;
const drawAxes = () => {
    const axes = new Group();
    const xLine = new Path.Line([0, origin.y], [paper.view.size.width, origin.y]);
    const yLine = new Path.Line([origin.x + 140, 0], [origin.x + 140, paper.view.size.height]);
    [xLine, yLine].forEach(l => {
        l.strokeColor = '#333';
        l.dashArray = [4, 4];
    });
    const centerPoint = new Path.Circle(new Point(origin.x + 140, origin.y), 5);
    centerPoint.strokeColor = '#00ff41';
    return centerPoint.position;
};
const realOrigin = drawAxes();

// --- ESTADO ---
let mode = 'LINE';
let entities = [];
let tempPath = null;
let selectedForDim = null;

function setMode(m) {
    mode = m;
    document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tool-' + m.toLowerCase())?.classList.add('active');
}

// --- COINCIDENCIA AUTOMÁTICA Y SNAP ---
function getSnapPoint(point) {
    const tolerance = 15;
    if (point.getDistance(realOrigin) < tolerance) return realOrigin;
    
    for (let ent of entities) {
        for (let seg of ent.segments) {
            if (point.getDistance(seg.point) < tolerance) return seg.point;
        }
    }
    return point;
}

const tool = new paper.Tool();

tool.onMouseDown = (event) => {
    const snapPt = getSnapPoint(event.point);
    const hit = paper.project.hitTest(event.point, { segments: true, stroke: true, tolerance: 10 });

    if (mode === 'DIM' && hit && hit.item.data.type === 'segment') {
        openDimEditor(hit.item, event.point);
        return;
    }

    if (mode === 'LINE') {
        tempPath = new Path.Line(snapPt, snapPt);
        tempPath.strokeColor = '#3b82f6';
        tempPath.strokeWidth = 2;
        tempPath.data.type = 'segment';
    } else if (mode === 'RECT') {
        tempPath = new Path.Rectangle(snapPt, new paper.Size(1,1));
        tempPath.strokeColor = '#3b82f6';
        tempPath.strokeWidth = 2;
        tempPath.data.type = 'rect';
    }
};

tool.onMouseDrag = (event) => {
    if (!tempPath) return;
    const snapPt = getSnapPoint(event.point);
    
    if (mode === 'LINE') {
        tempPath.segments[1].point = snapPt;
    } else if (mode === 'RECT') {
        const rect = new paper.Rectangle(tempPath.bounds.topLeft, snapPt);
        tempPath.remove();
        tempPath = new Path.Rectangle(rect);
        tempPath.strokeColor = '#3b82f6';
        tempPath.data.type = 'rect';
    }
};

tool.onMouseUp = () => {
    if (tempPath) {
        entities.push(tempPath);
        checkDefinitions();
        tempPath = null;
    }
};

// --- EDITOR DE COTAS (SIN PROMPT) ---
const editor = document.getElementById('dim-editor');
const input = document.getElementById('dim-input');

function openDimEditor(item, point) {
    selectedForDim = item;
    editor.style.display = 'block';
    editor.style.left = (point.x + 10) + 'px';
    editor.style.top = (point.y - 10) + 'px';
    
    const dist = item.segments[0].point.getDistance(item.segments[1].point);
    input.value = Math.round(dist);
    input.focus();
}

input.onkeydown = (e) => {
    if (e.key === 'Enter') {
        const newDist = parseFloat(input.value);
        applyDimension(selectedForDim, newDist);
        editor.style.display = 'none';
    }
};

function applyDimension(path, val) {
    const p1 = path.segments[0].point;
    const p2 = path.segments[1].point;
    const currentDist = p1.getDistance(p2);
    const vector = p2.subtract(p1).normalize().multiply(val);
    path.segments[1].point = p1.add(vector);
    
    // Crear Texto de Cota
    const label = new TextItem({
        point: p1.add(vector.divide(2)).add([0, -10]),
        content: val,
        fillColor: '#00ff41',
        fontSize: 12
    });
    checkDefinitions();
}

// --- ARCO ANGULAR ---
// Si se seleccionan dos líneas en modo DIM, se puede crear un arco.
// Aquí simplificamos la lógica visual del arco.
function drawAngleArc(line1, line2) {
    const center = line1.segments[0].point; // Asumimos vértice común
    const arc = new Path.Arc({
        from: line1.segments[1].point,
        through: line1.segments[1].point.add(line2.segments[1].point).divide(2),
        to: line2.segments[1].point,
        strokeColor: '#00ff41'
    });
}

function checkDefinitions() {
    entities.forEach(ent => {
        let defined = false;
        ent.segments.forEach(s => {
            if (s.point.getDistance(realOrigin) < 1) defined = true;
        });
        ent.strokeColor = defined ? '#00ff41' : '#3b82f6';
    });
}

</script>
</body>
</html>
