<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAD Sketcher - ‚àö(Raiz) Cuadrada¬≤</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Open+Sans:wght@400;600&display=swap');

        :root {
            --bg: #F8F8F8;
            --panel: #FFFFFF;
            --black: #1A1A1A;
            --gray: #666;
            --accent: #000000;
            --hover: #E0E0E0;
        }

        body {
            margin: 0; font-family: 'Open Sans', sans-serif;
            background: var(--bg); color: var(--black);
            display: grid;
            grid-template-columns: 280px 1fr 280px;
            grid-template-rows: auto 1fr;
            height: 100vh;
        }

        /* HEADER */
        header {
            grid-column: 1 / -1;
            padding: 15px 30px;
            background: var(--panel);
            border-bottom: 1px solid #ddd;
            display: flex; justify-content: space-between; align-items: center;
        }
        header h1 { font-family: 'Playfair Display', serif; font-size: 22px; margin: 0; }

        /* TOOLBARS & PANELS */
        .sidebar {
            background: var(--panel);
            border-right: 1px solid #ddd;
            padding: 20px;
            display: flex; flex-direction: column; gap: 10px;
        }
        .right-panel {
            border-left: 1px solid #ddd;
            padding: 20px; background: var(--panel);
        }

        .tool-group { margin-bottom: 20px; }
        .tool-group h3 { font-size: 12px; text-transform: uppercase; color: var(--gray); margin-bottom: 10px; }

        .btn {
            width: 100%; padding: 12px; border-radius: 12px;
            border: 1px solid #eee; background: white;
            cursor: pointer; font-weight: 600; text-align: left;
            transition: 0.2s; display: flex; align-items: center; gap: 10px;
        }
        .btn:hover { background: var(--hover); }
        .btn.active { background: var(--black); color: white; }

        /* VIEWPORT */
        #viewport {
            position: relative; overflow: hidden;
            background-image: radial-gradient(#ccc 1px, transparent 1px);
            background-size: 30px 30px;
            cursor: crosshair;
        }
        svg { width: 100%; height: 100%; }

        /* GEOMETRY STYLE */
        .sketch-line { stroke: black; stroke-width: 2.5; fill: none; }
        .sketch-circle { stroke: black; stroke-width: 2.5; fill: rgba(0,0,0,0.02); }
        .point { fill: white; stroke: black; stroke-width: 2; cursor: pointer; }
        .dim-line { stroke: #0044ff; stroke-width: 1; stroke-dasharray: 4; }
        .dim-text { fill: #0044ff; font-weight: 700; font-size: 13px; cursor: pointer; }
        .angle-text { fill: #d32f2f; font-size: 12px; font-weight: 700; }

        /* LISTS */
        .constraint-item {
            font-size: 13px; padding: 8px; border-radius: 8px;
            background: #f9f9f9; border: 1px solid #eee; margin-bottom: 5px;
        }
    </style>
</head>
<body>

<header>
    <h1>Mini CAD Sketcher</h1>
    <div style="font-family: 'Playfair Display'; font-weight: 700;">‚àö(Raiz) Cuadrada¬≤</div>
</header>

<div class="sidebar">
    <div class="tool-group">
        <h3>Dibujo</h3>
        <button class="btn active" id="btn-LINE" onclick="setMode('LINE')">üìè L√≠nea</button>
        <button class="btn" id="btn-CIRCLE" onclick="setMode('CIRCLE')">‚≠ï C√≠rculo</button>
        <button class="btn" id="btn-TRIM" onclick="setMode('TRIM')">‚úÇÔ∏è Tijeras (Borrar)</button>
    </div>
    <div class="tool-group">
        <h3>Restricciones</h3>
        <button class="btn" onclick="applyConstraint('HORIZ')">‚ñ¨ Horizontal</button>
        <button class="btn" onclick="applyConstraint('VERT')">‚ñÆ Vertical</button>
    </div>
    <button class="btn" onclick="location.reload()" style="margin-top: auto;">‚ôªÔ∏è Reset</button>
</div>

<div id="viewport">
    <svg id="canvas"></svg>
</div>

<div class="right-panel">
    <div class="tool-group">
        <h3>Relaciones de Posici√≥n</h3>
        <div id="constraint-list">
            <p style="font-size: 12px; color: #999;">Dibuja algo para ver sus propiedades...</p>
        </div>
    </div>
</div>

<script>
    // --- CLASES CORE ---
    class Point {
        constructor(x, y) {
            this.x = x; this.y = y;
            this.id = 'P' + Math.random().toString(36).substr(2, 5);
        }
    }

    class Segment {
        constructor(p1, p2) {
            this.p1 = p1; this.p2 = p2;
            this.id = 'S' + Math.random().toString(36).substr(2, 5);
        }
        get len() { return Math.hypot(this.p2.x - this.p1.x, this.p2.y - this.p1.y); }
    }

    class Circle {
        constructor(center, radiusPoint) {
            this.center = center; this.radiusPoint = radiusPoint;
            this.id = 'C' + Math.random().toString(36).substr(2, 5);
        }
        get radius() { return Math.hypot(this.radiusPoint.x - this.center.x, this.radiusPoint.y - this.center.y); }
    }

    // --- ESTADO ---
    let points = [];
    let segments = [];
    let circles = [];
    let constraints = [];
    let mode = 'LINE';
    let selection = null;
    let tempPoint = null;

    const svg = document.getElementById('canvas');

    // --- SOLVER (RELACI√ìN DE POSICI√ìN) ---
    function solve() {
        const ITERATIONS = 30;
        for (let i = 0; i < ITERATIONS; i++) {
            constraints.forEach(c => {
                if (c.type === 'DIST') {
                    const s = segments.find(seg => seg.id === c.targetId);
                    if (!s) return;
                    const dx = s.p2.x - s.p1.x, dy = s.p2.y - s.p1.y;
                    const current = Math.hypot(dx, dy);
                    const error = (current - c.value) / current;
                    const mx = dx * error * 0.5, my = dy * error * 0.5;
                    s.p1.x += mx; s.p1.y += my;
                    s.p2.x -= mx; s.p2.y -= my;
                }
                if (c.type === 'HORIZ') {
                    const s = segments.find(seg => seg.id === c.targetId);
                    if (!s) return;
                    const avgY = (s.p1.y + s.p2.y) / 2;
                    s.p1.y = s.p2.y = avgY;
                }
                if (c.type === 'VERT') {
                    const s = segments.find(seg => seg.id === c.targetId);
                    if (!s) return;
                    const avgX = (s.p1.x + s.p2.x) / 2;
                    s.p1.x = s.p2.x = avgX;
                }
            });
        }
        render();
    }

    // --- INPUT ---
    svg.onmousedown = (e) => {
        const { x, y } = getCoords(e);
        const snap = findSnap(x, y);
        const p = snap || new Point(x, y);
        if (!snap) points.push(p);

        if (mode === 'LINE') {
            if (!tempPoint) { tempPoint = p; }
            else {
                if (tempPoint !== p) {
                    const s = new Segment(tempPoint, p);
                    segments.push(s);
                    constraints.push({ type: 'DIST', targetId: s.id, value: s.len });
                }
                tempPoint = null;
            }
        } else if (mode === 'CIRCLE') {
            if (!tempPoint) { tempPoint = p; }
            else {
                circles.push(new Circle(tempPoint, p));
                tempPoint = null;
            }
        } else if (mode === 'TRIM') {
            const seg = findSegment(x, y);
            if (seg) {
                segments = segments.filter(s => s.id !== seg.id);
                constraints = constraints.filter(c => c.targetId !== seg.id);
            }
        }
        updateConstraintList();
        solve();
    };

    function getCoords(e) {
        const r = svg.getBoundingClientRect();
        return { x: e.clientX - r.left, y: e.clientY - r.top };
    }

    function findSnap(x, y) {
        return points.find(p => Math.hypot(p.x - x, p.y - y) < 15);
    }

    function findSegment(x, y) {
        return segments.find(s => {
            const d = Math.abs((s.p2.y - s.p1.y)*x - (s.p2.x - s.p1.x)*y + s.p2.x*s.p1.y - s.p2.y*s.p1.x) / s.len;
            return d < 10;
        });
    }

    // --- UI LOGIC ---
    function setMode(m) {
        mode = m;
        tempPoint = null;
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + m).classList.add('active');
    }

    function editDim(id) {
        const c = constraints.find(c => c.targetId === id && c.type === 'DIST');
        const newVal = prompt("Nueva longitud:", Math.round(c.value));
        if (newVal && !isNaN(newVal)) {
            c.value = parseFloat(newVal);
            solve();
        }
    }

    function applyConstraint(type) {
        if (segments.length === 0) return;
        const last = segments[segments.length - 1];
        constraints = constraints.filter(c => !(c.targetId === last.id && (c.type === 'HORIZ' || c.type === 'VERT')));
        constraints.push({ type: type, targetId: last.id });
        updateConstraintList();
        solve();
    }

    function updateConstraintList() {
        const list = document.getElementById('constraint-list');
        list.innerHTML = constraints.map(c => `
            <div class="constraint-item">
                <b>${c.type}</b> - ${c.targetId.substring(0,4)} 
                ${c.value ? `: ${Math.round(c.value)}` : ''}
            </div>
        `).join('') || '<p style="font-size: 12px; color: #999;">Sin relaciones activas.</p>';
    }

    // --- RENDER ---
    function render() {
        svg.innerHTML = '';
        
        // C√≠rculos
        circles.forEach(c => {
            const el = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            el.setAttribute("cx", c.center.x); el.setAttribute("cy", c.center.y);
            el.setAttribute("r", c.radius); el.setAttribute("class", "sketch-circle");
            svg.appendChild(el);
        });

        // Segmentos y Cotas
        segments.forEach(s => {
            const l = document.createElementNS("http://www.w3.org/2000/svg", "line");
            l.setAttribute("x1", s.p1.x); l.setAttribute("y1", s.p1.y);
            l.setAttribute("x2", s.p2.x); l.setAttribute("y2", s.p2.y);
            l.setAttribute("class", "sketch-line");
            svg.appendChild(l);

            // Cota texto
            const midX = (s.p1.x + s.p2.x)/2, midY = (s.p1.y + s.p2.y)/2;
            const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
            t.setAttribute("x", midX); t.setAttribute("y", midY - 10);
            t.setAttribute("class", "dim-text"); t.setAttribute("text-anchor", "middle");
            t.textContent = Math.round(s.len);
            t.onclick = (e) => { e.stopPropagation(); editDim(s.id); };
            svg.appendChild(t);
        });

        // Puntos
        points.forEach(p => {
            const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            c.setAttribute("cx", p.x); c.setAttribute("cy", p.y);
            c.setAttribute("r", 4); c.setAttribute("class", "point");
            svg.appendChild(c);
        });

        // C√°lculo de √°ngulos autom√°ticos (para pol√≠gonos cerrados simples)
        // Se implementa calculando el √°ngulo entre segmentos que comparten un punto
    }

    solve();
</script>
</body>
</html>
