<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mini Solid Sketcher</title>
<style>
body{margin:0;font-family:sans-serif;background:#eee}
#bar{padding:6px;background:#333;color:#fff;font-size:13px}
#tools{padding:6px;background:#ddd;display:flex;gap:6px}
button{padding:5px 8px}
svg{background:#fff;width:100vw;height:calc(100vh - 70px)}
.line{stroke:#222;stroke-width:2}
.point{fill:#007bff}
.axis{stroke:#aaa;stroke-width:1;stroke-dasharray:4}
.dimText{fill:#d00;font-size:11px;font-weight:bold;cursor:pointer}
.arc{stroke:#d00;fill:none;stroke-width:1.5}
</style>
</head>
<body>

<div id="bar">MINI SOLID SKETCHER — DIST + ANGLE</div>
<div id="tools">
<button onclick="setMode('LINE')">Linea</button>
<button onclick="setMode('RECT')">Rect</button>
<button onclick="setMode('CIRCLE')">Circulo</button>
<button onclick="setMode('DIM')">Cota</button>
<button onclick="setMode('ANGLE')">Angulo</button>
<button onclick="undo()">Undo</button>
<button onclick="redo()">Redo</button>
</div>

<svg id="svg"></svg>

<script>
/* ===================== CORE STATE ===================== */
let state={pts:[],segs:[],cir:[],cons:[]}
let hist=[],redoS=[]
let mode='LINE',tmp=[]
const EPS=1e-6
const svg=document.getElementById('svg')

/* ===================== HELPERS ===================== */
const id=()=>Math.random().toString(36).slice(2)
const P=id=>state.pts.find(p=>p.id===id)
const dist=(a,b)=>Math.hypot(b.x-a.x,b.y-a.y)

function save(){hist.push(JSON.parse(JSON.stringify(state)));redoS=[]}
function undo(){if(hist.length){redoS.push(state);state=hist.pop();draw()}}
function redo(){if(redoS.length){hist.push(state);state=redoS.pop();draw()}}

function normAngleVis(deg){
deg=((deg%360)+360)%360
return deg>180?360-deg:deg
}

/* ===================== SOLVER ===================== */
function solve(){
for(let i=0;i<40;i++){
let err=0
for(const c of state.cons){
if(c.type==='DIST'){
const s=state.segs.find(s=>s.id===c.sid); if(!s)continue
const a=P(s.a),b=P(s.b)
let d=dist(a,b); if(d<EPS)continue
let diff=(d-c.v)/d*0.5
diff=Math.max(-10,Math.min(10,diff))
a.x+= (b.x-a.x)*diff
a.y+= (b.y-a.y)*diff
b.x-= (b.x-a.x)*diff
b.y-= (b.y-a.y)*diff
err=Math.max(err,Math.abs(d-c.v))
}
if(c.type==='ANGLE'){
const s1=state.segs.find(s=>s.id===c.s1)
const s2=state.segs.find(s=>s.id===c.s2)
if(!s1||!s2)continue
const vId=[s1.a,s1.b].find(x=>x===s2.a||x===s2.b)
if(!vId)continue
const v=P(vId)
const p1=P(s1.a===vId?s1.b:s1.a)
const p2=P(s2.a===vId?s2.b:s2.a)
let a1=Math.atan2(p1.y-v.y,p1.x-v.x)
let a2=Math.atan2(p2.y-v.y,p2.x-v.x)
let diff=(c.v*Math.PI/180)-(a2-a1)
diff=Math.max(-0.5,Math.min(0.5,diff))
const cs=Math.cos(diff),sn=Math.sin(diff)
const x=p2.x-v.x,y=p2.y-v.y
p2.x=v.x+x*cs-y*sn
p2.y=v.y+x*sn+y*cs
err=Math.max(err,Math.abs(diff))
}
}
if(err<EPS)break
}
}

/* ===================== DRAW ===================== */
function draw(){
svg.innerHTML=''
const w=svg.clientWidth,h=svg.clientHeight
const ox=w/2,oy=h/2

// axes
let ax=document.createElementNS(svg.namespaceURI,'line')
ax.setAttribute('x1',0);ax.setAttribute('y1',oy)
ax.setAttribute('x2',w);ax.setAttribute('y2',oy)
ax.setAttribute('class','axis');svg.appendChild(ax)
let ay=document.createElementNS(svg.namespaceURI,'line')
ay.setAttribute('x1',ox);ay.setAttribute('y1',0)
ay.setAttribute('x2',ox);ay.setAttribute('y2',h)
ay.setAttribute('class','axis');svg.appendChild(ay)

// segments
for(const s of state.segs){
const a=P(s.a),b=P(s.b)
let l=document.createElementNS(svg.namespaceURI,'line')
l.setAttribute('x1',a.x+ox);l.setAttribute('y1',oy-a.y)
l.setAttribute('x2',b.x+ox);l.setAttribute('y2',oy-b.y)
l.setAttribute('class','line');svg.appendChild(l)
}

// points
for(const p of state.pts){
let c=document.createElementNS(svg.namespaceURI,'circle')
c.setAttribute('cx',p.x+ox);c.setAttribute('cy',oy-p.y)
c.setAttribute('r',4);c.setAttribute('class','point')
svg.appendChild(c)
}

// dimensions
for(const c of state.cons){
if(c.type==='DIST'){
const s=state.segs.find(s=>s.id===c.sid)
const a=P(s.a),b=P(s.b)
let tx=(a.x+b.x)/2,ty=(a.y+b.y)/2
let t=document.createElementNS(svg.namespaceURI,'text')
t.textContent=Math.round(c.v)
t.setAttribute('x',tx+ox+5);t.setAttribute('y',oy-ty-5)
t.setAttribute('class','dimText')
svg.appendChild(t)
}
if(c.type==='ANGLE'){
const s1=state.segs.find(s=>s.id===c.s1)
const s2=state.segs.find(s=>s.id===c.s2)
const vId=[s1.a,s1.b].find(x=>x===s2.a||x===s2.b)
const v=P(vId)
let t=document.createElementNS(svg.namespaceURI,'text')
t.textContent=Math.round(normAngleVis(c.v))+'°'
t.setAttribute('x',v.x+ox+15);t.setAttribute('y',oy-v.y-15)
t.setAttribute('class','dimText')
svg.appendChild(t)
}
}
}

/* ===================== INTERACTION ===================== */
function setMode(m){mode=m;tmp=[]}

svg.onmousedown=e=>{
const r=svg.getBoundingClientRect()
const x=e.clientX-r.left-svg.clientWidth/2
const y=svg.clientHeight/2-(e.clientY-r.top)
if(mode==='LINE'){
const p={x,y,id:id()}
state.pts.push(p)
if(tmp[0]){
save()
state.segs.push({a:tmp[0],b:p.id,id:id()})
tmp=[]
}else tmp=[p.id]
}
draw()
}

draw()
</script>
</body>
</html>
